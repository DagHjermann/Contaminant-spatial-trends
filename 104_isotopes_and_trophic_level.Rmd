---
title: "104_Isotopes_and_trophic_level"
author: "DHJ"
date: "19 5 2020"
output: 
  html_document:
    keep_md: true
    toc: true
    toc_float: true
    code_folding: hide 
---


Mail fra Anders 13.05.2020:  
  
Trofisk nivå for de enkelte torskeindivider regnes ut slik:
  
`TL_torsk = 2 + (Delta15N_torsk - Delta15N_blåskjell)/3.8`     
  
Her er `Delta15N_torsk` verdien av d15N for den enkelte torsken, mens `Delta15N_blåskjell` er gjennomsnittlig verdi av d15N i blåskjell fra den nærmeste blåskjellstasjonen.  

Ligningen har som antakelse at alle blåskjell langs kysten er på trofisk nivå ca. 2 (altså at de er primærkonsumenter) og at d15N øker med 3.8 for hvert (hele) trofiske nivå i næringskjeden.  


## 1. Libraries  
```{r, warning=FALSE, message=FALSE, results='hide'}

library(dplyr)
library(forcats)   # fct_reorder()
library(ggplot2)
library(leaflet)
library(knitr)
library(purrr)

library(safejoin)  # package from https://github.com/moodymudskipper/safejoin 

library(sp)
crs_longlat <- "+proj=longlat +ellps=WGS84 +datum=WGS84"
crs_utm <- "+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m"



```


## 2. Data

### Read files   
NOTE: the file `87_df_isotopes.rds` is created in the `Milkys` project and copied from there
```{r, results = 'hold'}

# Raw data  
dat <- readRDS("Data/101_Selected_data.rds") %>%
  mutate(STATION_CODE = case_when(
    STATION_CODE %in% "36A" ~ "36A1",
    TRUE ~ STATION_CODE)
    )

cat("\nRaw data: \n")
xtabs(~MYEAR, dat)

# Extra isotope data  
# created in the `Milkys` project and copied from there
dat_isotopes <- readRDS("Input_data/87_df_isotopes.rds") %>%
  mutate(STATION_CODE = case_when(
    STATION_CODE %in% "36A" ~ "36A1",
    TRUE ~ STATION_CODE)
    )

cat("\n\nIsotope data: \n")
xtabs(~MYEAR, dat_isotopes)
xtabs(~STATION_CODE, dat_isotopes)

# Station metadata
df_stations <- readRDS("Data/103_Selected_stations.rds")

# Station metadata needs to be summarised  
df_stations <- df_stations %>%
  mutate(MSTAT = case_when(
    STATION_CODE %in% "I969" ~ "RH",
    TRUE ~ MSTAT)) %>%
  group_by(STATION_CODE, MSTAT) %>%
  summarise_at(vars("Lat", "Lon", "Dist_along_coast"), mean, na.rm = TRUE)




```


#### Stations by year    
```{r}

dat %>%
  filter(substr(PARAM, 1, 2) == "PF" & MYEAR >= 2014) %>%
  xtabs(~STATION_CODE + MYEAR, .) %>%
  knitr::kable()
  

```

### Add position       
Using `df_stations`   
Position lacking for stations 19B (Barents Sea - no blue mussel close anyway)  
```{r, results = 'hold'}

dat_isotopes <- dat_isotopes %>%
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE")

check <- dat_isotopes %>%
  group_by(STATION_CODE) %>%
  summarise(Lat = first(Lat), .groups = "drop")

cat("Positions added for", sum(!is.na(check$Lat)), "stations \n")
cat("Positions lacking for", sum(is.na(check$Lat)), "stations \n")
if (sum(is.na(check$Lat)) > 0)
  cat("- positions lacking for stations", check$STATION_CODE[is.na(check$Lat)] %>% paste(collapse = ", "), "\n")

```
### Data for plotting maps   
From script 122 (without adaption)      
```{r}
#
# Get Norway map data
#
test <- maps::map("world", "Norway", plot = FALSE)   # map data for Norway - this is just to get region names
sel <- grepl("Svalbard", test$names) | test$names == "Norway:Jan Mayen"  # select Svalbard + Jan Mayen
# test$names[!sel]
map <- maps::map("world", test$names[!sel], exact = TRUE, plot = FALSE)  # Norway w/o Svalbard + Jan Mayen
mapdata <- data.frame(Longitude = map$x, Latitude = map$y)

#
# Add UTM coordinates (x and y) to map
#
coordinate_exists <- !is.na(mapdata$Longitude)   # sp doesn't like NAs
SP <- sp::SpatialPoints(mapdata[coordinate_exists, c("Longitude", "Latitude")],
                    proj4string=CRS(crs_longlat)
)
SP.UTM <- sp::spTransform(SP, CRS(crs_utm))
# Add transformed coords to data set
mapdata$x[coordinate_exists] <- SP.UTM@coords[,1]
mapdata$y[coordinate_exists] <- SP.UTM@coords[,2]


#
# "Coast" data (coordinates for segments along the coast)
#
coast <- readRDS("Data/102_coast_coordinates.rmd")

#
# Make 'coastsegment_distance'   
#
# Distances for start points of the coast segments
segment_dx <- diff(coast$x)/1000
segment_dy <- diff(coast$y)/1000
coastsegment_distance <- sqrt(segment_dx^2 + segment_dy^2) %>% cumsum()
coastsegment_distance <- c(0, coastsegment_distance)


```


```{r}
source("103_Distance_along_coast_functions.R")

```

```{r}
  
plot_coast_distance <- function(map, coast){
  
    # Get positions for km's to show:
  points <- c(0, 500, 1000, 1500, 2000, 2500, 2685) %>% map_df(~get_point_on_coastline(.))
  
  
  # Direction of text labels:
  points$Text_direction <- "West"
  points$Text_direction[c(1,6,7)] <- "East"
  
  # PLot
  gg2 <- ggplot(map, aes(x, y)) +
    geom_path() +
    coord_fixed() +
    geom_path(data = coast, color = "red") +
    geom_point(data = points, color = "blue") +
    geom_text(data = points %>% filter(Text_direction == "West"), 
              aes(x = x - 20000, label = paste(distance, "km")), 
              color = "blue", hjust = 1, size = rel(3)) +
    geom_text(data = points %>% filter(Text_direction == "East"), 
              aes(x = x + 20000, label = paste(distance, "km")), 
              color = "blue", hjust = 0, size = rel(3)) +
    expand_limits(x = c(min(mapdata$x, na.rm = TRUE) - 150000,
                        max(mapdata$x, na.rm = TRUE) + 200000)) +
    theme_minimal() +
    theme(
      axis.text = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank()
    )
  
gg2
}


# debugonce(plot_coast_distance)
plot_coast_distance(mapdata, coast)


```

## 3. Calculate means of Delta15N     
```{r}

dat_isotopes_means1 <- dat_isotopes %>%
  group_by(TISSUE_NAME, STATION_CODE, Lat, Lon, Dist_along_coast, MYEAR) %>%
  summarise_at(c("Delta13C", "Delta15N"), mean, na.rm = TRUE) %>%
  ungroup() %>%
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast),
         Organism = case_when(
           grepl("B", STATION_CODE) ~ "Cod",
           grepl("F", STATION_CODE) ~ "Flatfish",
           TRUE ~ "Blue mussel"
         ))

```


## 4. Plot Delta15N means, tile plots {.tabset}   

### Cod (muscle)  
```{r, fig.height=4, fig.width=9}

dat_isotopes_means1 %>%
  filter(TISSUE_NAME %in% "Muskel") %>%
  ggplot(aes(STATION_CODE, MYEAR, fill = Delta15N)) +
  geom_tile() +
  viridis::scale_fill_viridis() +
  scale_y_reverse() +
  labs(title = "Muskel")

```

### Blue mussel 
```{r, fig.height=4, fig.width=9}

dat_isotopes_means1 %>%
  filter(TISSUE_NAME %in% "Whole soft body") %>%
  ggplot(aes(STATION_CODE, MYEAR, fill = Delta15N)) +
  geom_tile() +
  viridis::scale_fill_viridis() +
  scale_y_reverse() +
  theme(axis.text.x = element_text(angle = -45, hjust = 0)) +
  labs(title = "Blue mussel")


```
## 5. Plot Delta15N means by distance along coast, tile plots {.tabset}   

### Cod (muscle)  
```{r, fig.height=5, fig.width=7}

dat_isotopes_means1 %>%
  filter(TISSUE_NAME %in% "Muskel") %>%
  ggplot(aes(Dist_along_coast, Delta15N)) +
  geom_point(aes(fill = MYEAR), shape = 21, size = rel(2)) +
  viridis::scale_fill_viridis() +
  geom_smooth(method = 'loess', formula = 'y ~ x') +
  labs(title = "Fish")

```


### Blue mussel  
```{r, fig.height=5, fig.width=7}

dat_isotopes_means1 %>%
  filter(TISSUE_NAME %in% "Whole soft body") %>%
  ggplot(aes(Dist_along_coast, Delta15N)) +
  geom_point(aes(fill = MYEAR), shape = 21, size = rel(2)) +
  viridis::scale_fill_viridis() +
  geom_smooth(method = 'loess', formula = 'y ~ x') +
  labs(title = "Blue mussel")

```



## 6. Find closest mussel station for each cod station   

### Leaflet map   

```{r}

dat_isotopes_stations <- dat_isotopes_means1 %>%
  group_by(TISSUE_NAME, STATION_CODE, Lat, Lon) %>%
  summarise(Years = paste(MYEAR, collapse = ", "), .groups = "drop") 


df <- dat_isotopes_stations %>% 
  filter(TISSUE_NAME %in% c("Muskel", "Whole soft body") & !is.na(Lat))

icons <- awesomeIcons(
  icon = 'ios-close',
  iconColor = 'black',
  library = 'ion',
  markerColor = case_when(
    df$TISSUE_NAME == "Whole soft body" ~ "blue",
    df$TISSUE_NAME == "Muskel" ~ "red")
)

leaflet(df) %>%
  addTiles() %>%
  addAwesomeMarkers(~Lon, ~Lat, icon = icons,
                    label =  ~STATION_CODE)
  
```


### Closest/corresponding mussel station   
Set based on map above  
```{r}

data_closest_mussel_station <- read.csv(textConnection("
Cod_station, Mussel_station
30B,I304
33F,35A
02B,I024
36F,36A1
71B,I712
13B,I133
15B,15A
23B,22A
24B,I241
53B,56A
80B,91A2
96B,I969
98B1,98A2
43B2,98A2
45B2,98A2
10B,11X
"),
stringsAsFactors = FALSE
)

# Pretty far from eacah other: 80B, 91A2

```


### Plot N15 for these cod and mussel stations  {.tabset}  

#### Cod
```{r}

dat_isotopes %>%
  filter(TISSUE_NAME %in% "Muskel" & 
           grepl("B", STATION_CODE) & 
           STATION_CODE %in% data_closest_mussel_station$Cod_station) %>%
  ggplot(aes(MYEAR, Delta15N)) +
  geom_jitter(width = 0.1) +
  facet_wrap(vars(STATION_CODE))

```

#### Blue mussel
```{r}
dat_isotopes %>%
  filter(TISSUE_NAME %in% "Whole soft body" &
         STATION_CODE %in% data_closest_mussel_station$Mussel_station) %>%
  ggplot(aes(MYEAR, Delta15N)) +
  geom_jitter(width = 0.1) +
  facet_wrap(vars(STATION_CODE))

```

### Summarise mussel data  
For each station (not year-specific means)  
```{r}

data_mussel_means <- dat_isotopes %>%
  filter(TISSUE_NAME %in% "Whole soft body" & 
           STATION_CODE %in% data_closest_mussel_station$Mussel_station) %>%
  filter(!(STATION_CODE %in% "I024" & MYEAR %in% 2017)) %>%
  group_by(STATION_CODE) %>%
  summarise_at(c("Delta13C", "Delta15N"), mean, na.rm = TRUE) %>%
  rename(Delta13C_mussel = Delta13C,
         Delta15N_mussel = Delta15N) %>%
  ungroup()

data_closest_mussel_station <- data_closest_mussel_station %>%
  left_join(data_mussel_means, by = c("Mussel_station" = "STATION_CODE"))

```



## 7. Add mussel data columns to main data   
### a. Add mussel and calculate trophic level (TL)   
All data, i.e. one line per parameter and sample  
```{r}

dat2 <- dat %>%
  # Add Delta13C, Delta15N for each individual
  left_join(
    dat_isotopes %>% 
      select(MYEAR, STATION_CODE, TISSUE_NAME, SAMPLE_NO2, Delta13C, Delta15N), 
    by = c("MYEAR", "STATION_CODE", "TISSUE_NAME", "SAMPLE_NO2")
  ) %>% # View()
  # Add Delta13C, Delta15N for closest mussel station
  left_join(
    data_closest_mussel_station, 
    by = c("STATION_CODE" = "Cod_station")) %>%
  ungroup() %>% 
  # Calculate trophic level (TL)
  mutate(
    TL = case_when(
      TISSUE_NAME %in% c("Lever", "Muskel") ~ 2 + (Delta15N - Delta15N_mussel)/3.8,
      TISSUE_NAME %in% "Whole soft body" ~ 2)
    )  %>%
  # Add Lat, Lon, Dist_along_coast, MSTAT
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE") %>%
  # Make STATION_CODE factor levels to follow 'Dist_along_coast'
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast))


# dat2$STATION_CODE %>% levels()

```


### b. Keep only isotopes and TL data    
Plus LNMEA etc
```{r}
dat3 <- dat2 %>%
  filter(TISSUE_NAME %in% "Muskel" & !is.na(TL)) %>%
  group_by(TISSUE_NAME, MYEAR, STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT, SAMPLE_NO2) %>%
  summarise(across(c(Delta15N, Delta15N_mussel, TL, LNMEA, FAT_PERC), first)) %>%
  mutate(MYEAR_f = factor(MYEAR),
         STATION_CODE = fct_drop(STATION_CODE)
         ) 

```

### c. Save  
```{r}

saveRDS(dat2, "Data/104_dat2.rds")
saveRDS(dat3, "Data/104_dat3.rds")
saveRDS(data_closest_mussel_station, "Data/104_data_closest_mussel_station.rds")

```


## 8. Plots {.tabset} 

### Median cod TL    
```{r}

dat2 %>%
  filter(TISSUE_NAME %in% "Muskel" &
           PARAM %in% "HG" &
           STATION_CODE %in% data_closest_mussel_station$Cod_station &
           !is.na(TL)) %>%
  group_by(MYEAR, STATION_CODE) %>%
  summarise(TL = median(TL), .groups = "drop") %>%
  ggplot(aes(STATION_CODE, MYEAR, fill = TL)) +
  geom_tile() +
  viridis::scale_fill_viridis() +
  scale_y_reverse() +
  labs(title = "Cod trophic level") 


```

### Cod TL, raw data 
```{r, fig.width=8, fig.height=8}

dat2 %>%
  filter(TISSUE_NAME %in% "Muskel" &
           PARAM %in% "HG" &
           STATION_CODE %in% data_closest_mussel_station$Cod_station &
           !is.na(TL)) %>%
  ggplot(aes(MYEAR, TL)) +
  geom_jitter(width = 0.25, alpha = 0.4) +
  facet_wrap(vars(STATION_CODE))


```


### Plot cod trophic level by mean length  
```{r, fig.width=8, fig.height=8}

dat2 %>%
  filter(TISSUE_NAME %in% "Muskel" &
           PARAM %in% "HG" &
           STATION_CODE %in% data_closest_mussel_station$Cod_station &
           !is.na(TL)) %>%
  ggplot(aes(LNMEA, TL, fill = MYEAR)) +
  geom_point(shape = 21, size = rel(2)) +
  viridis::scale_fill_viridis() +
  facet_wrap(vars(STATION_CODE))

```

## LMER test  
```{r}

if (FALSE){



```

```{r}

str(fm2, 2)

```

```{r}

```

```{r}

newdat <- expand.grid(
    STATION_CODE = 
    , Sex=c("Female","Male")
    , distance = 0
)
newdat$distance <- predict(fm1, newdat, re.form = NA)
mm <- model.matrix(terms(fm1), newdat)

newdat
mm

```



## 9. Statistical analysis: station + year    
```{r, results = 'hold'}

dat2b <- dat2 %>%
  filter(TISSUE_NAME %in% "Muskel" & TL < 6) %>% # cod - and remive one outlier 
  mutate(MYEAR = factor(MYEAR))

m0 <- lm(TL ~ 1, dat2b)
m1 <- lm(TL ~ MYEAR, dat2b)
m2 <- lm(TL ~ STATION_CODE, dat2b)
m3 <- lm(TL ~ MYEAR + STATION_CODE, dat2b)
m4 <- lm(TL ~ MYEAR*STATION_CODE, dat2b)    # Very slow!

cat("===========================================\n")
cat("\nEffect of MYEAR: \n\n")
anova(m0, m1)
cat("===========================================\n")
cat("\nEffect of STATION_CODE: \n\n")
anova(m0, m2)
cat("===========================================\n")
cat("\nEffect of STATION_CODE in addition to MYEAR: \n\n")
anova(m1, m3)
cat("===========================================\n")
cat("\nEffect of STATION_CODE*MYEAR interaction: \n\n")
anova(m3, m4)

```

### Station effect 1 (after removing year effect)     
Model: MYEAR + STATION_CODE  
```{r, fig.width=8.5, fig.height=5}  

# visreg::visreg(fit = m3, xvar = "STATION_CODE")

df_stationeffect1 <- visreg::visreg(fit = m3, xvar = "STATION_CODE", plot = FALSE)  
str(df_stationeffect1, 2)
levels(df_stationeffect1$fit$STATION_CODE)

# Add position plus Dist_along_coast
df_stationeffect1$fit <- df_stationeffect1$fit %>%
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE") %>%
  # put STATION_CODE in correct order  
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast))
# levels(df_stationeffect1$fit$STATION_CODE)

df_stationeffect1$res <- df_stationeffect1$res %>%
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE") %>%
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast))  


```



### Plot year effect  
```{r}

visreg::visreg(fit = m3, xvar = "MYEAR")  

```




## 10. Statistical analysis: station + year + length   
```{r, results = 'hold'}

# library(MuMIn)

m0 <- lm(TL ~ 1, dat2b)
m1 <- lm(TL ~ LNMEA, dat2b)
m2 <- lm(TL ~ STATION_CODE, dat2b)
m3 <- lm(TL ~ LNMEA + STATION_CODE, dat2b)
m3b <- lm(TL ~ LNMEA + STATION_CODE + MYEAR, dat2b)
m4 <- lm(TL ~ LNMEA*STATION_CODE, dat2b)
m4b <- lm(TL ~ LNMEA*STATION_CODE + MYEAR, dat2b)

cat("===========================================\n")
cat("\nEffect of length: \n\n")
anova(m0, m1)
cat("===========================================\n")
cat("\nEffect of STATION_CODE: \n\n")
anova(m0, m2)
cat("===========================================\n")
cat("\nEffect of STATION_CODE in addition to length: \n\n")
anova(m1, m3)
cat("===========================================\n")
cat("\nEffect of Year in addition to STATION_CODE + length: \n\n")
anova(m3, m3b)
cat("===========================================\n")
cat("\nEffect of STATION_CODE*length interaction: \n\n")
anova(m3, m4)
cat("===========================================\n")
cat("\nAdding STATION_CODE*length interaction to STATION_CODE + length + year model: \n\n")
anova(m3b, m4b)

```



### Get length effect depending on station  {.tabset} 
Model: Length * STATION_CODE + Year  
```{r, fig.width=8.5, fig.height=5}  

# visreg::visreg(fit = m4b, xvar = "LNMEA", by = "STATION_CODE", gg = TRUE)

df_effects <- visreg::visreg(fit = m4b, xvar = "LNMEA", by = "STATION_CODE", plot = FALSE)  

# str(df_effects, 2)
# levels(df_effects$fit$STATION_CODE)

# Add position plus Dist_along_coast
df_effects$fit <- df_effects$fit %>%
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE") %>%
  # put STATION_CODE in correct order  
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast))
# levels(df_stationeffect$fit$STATION_CODE)

df_effects$res <- df_effects$res %>%
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE") %>%
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast))  


```

#### Length effect    
```{r}

ggplot(df_effects$fit, aes(x = LNMEA)) +
  geom_ribbon(aes(ymin = visregLwr, ymax = visregUpr), fill = "lightblue") +
  geom_line(aes(y = visregFit)) +
  facet_wrap(vars(STATION_CODE))

```

#### Length effect with residuals      
```{r}

ggplot(df_effects$fit, aes(x = LNMEA)) +
  geom_ribbon(aes(ymin = visregLwr, ymax = visregUpr), fill = "lightblue") +
  geom_point(data = df_effects$res, aes(y = visregRes), size = rel(0.5)) +
  geom_line(aes(y = visregFit)) +
  facet_wrap(vars(STATION_CODE))

```



### Station effect 2, 40 cm cod (after removing year and length effect)     
Model: MYEAR + STATION_CODE * Length 
```{r}

# visreg::visreg(fit = m4b, xvar = "STATION_CODE", cond = list(LNMEA = 600, MYEAR = 2019), gg = TRUE)

df_stationeffect2 <- visreg::visreg(
  fit = m4b, 
  xvar = "STATION_CODE", 
  cond = list(LNMEA = 400, MYEAR = 2019), 
  plot = FALSE)  


# Add position plus Dist_along_coast
df_stationeffect2$fit <- df_stationeffect2$fit %>%
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE") %>%
  # put STATION_CODE in correct order  
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast))
# levels(df_stationeffect$fit$STATION_CODE)

df_stationeffect2$res <- df_stationeffect2$res %>%
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE") %>%
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast))  


```

### Station effect3, 70 cm cod (after removing year and length effect)     
Model: MYEAR + STATION_CODE * Length 
```{r}

# visreg::visreg(fit = m4b, xvar = "STATION_CODE", cond = list(LNMEA = 600, MYEAR = 2019), gg = TRUE)

df_stationeffect3 <- visreg::visreg(
  fit = m4b, 
  xvar = "STATION_CODE", 
  cond = list(LNMEA = 700, MYEAR = 2019), 
  plot = FALSE)  


# Add position plus Dist_along_coast
df_stationeffect3$fit <- df_stationeffect3$fit %>%
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE") %>%
  # put STATION_CODE in correct order  
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast))
# levels(df_stationeffect$fit$STATION_CODE)

df_stationeffect3$res <- df_stationeffect3$res %>%
  safe_left_join(df_stations %>% select(STATION_CODE, Lat, Lon, Dist_along_coast, MSTAT), 
                 na_matches = "never",
                 check = "CV",
                 by = "STATION_CODE") %>%
  mutate(STATION_CODE = fct_reorder(STATION_CODE, Dist_along_coast))  


```

## 11. Plot station effects {.tabset}

### Mean TL  
```{r}
ggplot(df_stationeffect1$fit, aes(STATION_CODE)) +
  geom_crossbar(aes(y = visregFit, ymin = visregLwr, ymax = visregUpr), color = "red3")
```

### Mean TL (w/ residuals)  
```{r}
ggplot(df_stationeffect1$fit, aes(STATION_CODE)) +
  geom_jitter(data = df_stationeffect1$res, aes(y = visregRes), width = 0.1) +
  geom_crossbar(aes(y = visregFit, ymin = visregLwr, ymax = visregUpr), color = "red3")
```

### TL 40 cm cod 
```{r}
ggplot(df_stationeffect2$fit, aes(STATION_CODE)) +
  geom_crossbar(aes(y = visregFit, ymin = visregLwr, ymax = visregUpr), color = "red3")
```

### TL 40 cm cod (w/ residuals)  
```{r}
ggplot(df_stationeffect2$fit, aes(STATION_CODE)) +
  geom_jitter(data = df_stationeffect2$res, aes(y = visregRes), width = 0.1) +
  geom_crossbar(aes(y = visregFit, ymin = visregLwr, ymax = visregUpr), color = "red3")
```


### TL 70 cm cod 
```{r}
ggplot(df_stationeffect3$fit, aes(STATION_CODE)) +
  geom_crossbar(aes(y = visregFit, ymin = visregLwr, ymax = visregUpr), color = "red3")
```

### TL 70 cm cod (w/ residuals)  
```{r}
ggplot(df_stationeffect3$fit, aes(STATION_CODE)) +
  geom_jitter(data = df_stationeffect3$res, aes(y = visregRes), width = 0.1) +
  geom_crossbar(aes(y = visregFit, ymin = visregLwr, ymax = visregUpr), color = "red3")
```

### Mean TL vs distance      
```{r}
ggplot(df_stationeffect1$fit, aes(Dist_along_coast)) +
  geom_point(aes(y = visregFit), color = "red3", size = rel(2)) +
  geom_errorbar(aes(ymin = visregLwr, ymax = visregUpr), color = "red3", width = 100)
```


### TL 40 cm vs distance      
```{r}
ggplot(df_stationeffect2$fit, aes(Dist_along_coast)) +
  geom_point(aes(y = visregFit), color = "red3", size = rel(2)) +
  geom_errorbar(aes(ymin = visregLwr, ymax = visregUpr), color = "red3", width = 100)
```


### TL 70 cm vs distance      
```{r}
ggplot(df_stationeffect3$fit, aes(Dist_along_coast)) +
  geom_point(aes(y = visregFit), color = "red3", size = rel(2)) +
  geom_errorbar(aes(ymin = visregLwr, ymax = visregUpr), color = "red3", width = 100)
```











## 12. Save data  
```{r}

if (FALSE){
  saveRDS(dat2, "Data/104_Selected_data.rds")
}

```

